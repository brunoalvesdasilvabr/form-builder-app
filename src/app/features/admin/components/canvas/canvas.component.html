<div class="canvas-wrapper">
  <div class="canvas-toolbar">
    <div class="canvas-toolbar-buttons">
      <select
        class="canvas-toolbar-select"
        [ngModel]="selectedLayoutId()"
        (ngModelChange)="onLayoutSelect($event)"
        title="Switch layout"
      >
        <option [ngValue]="null">— New layout —</option>
        @for (layout of layouts(); track layout.id) {
          <option [ngValue]="layout.id">{{ layout.name }}</option>
        }
      </select>
      <button type="button" class="btn btn-primary" (click)="addColumn()" title="Add column">+ Col</button>
      <button type="button" class="btn btn-danger" (click)="removeColumn()" [disabled]="!canRemoveColumn()" title="Remove column">− Col</button>
      <button type="button" class="btn btn-primary" (click)="addRow()" title="Add row">+ Row</button>
      <button type="button" class="btn btn-danger" (click)="removeRow()" [disabled]="!canRemoveRow()" title="Remove row">− Row</button>
      @if (canMerge()) {
        <button type="button" class="btn btn-secondary" (click)="mergeSelection()">Merge selected</button>
      }
      <button type="button" class="btn btn-secondary" (click)="openPreview()" title="Preview canvas HTML">Preview</button>
      <button type="button" class="btn btn-secondary" (click)="saveLayout()" title="Log canvas HTML">Save layout</button>
    </div>
    <p class="canvas-toolbar-hint">Ctrl+click two corners (e.g. top-left then bottom-right) to select a rectangle—cells inside merged regions are included automatically. Ctrl+click a selected cell to unselect it. Right‑click merged cell to unmerge.</p>
  </div>

  <div class="canvas-scroll" #canvasArea>
    <table class="canvas-table">
      <tbody>
        @for (row of rows(); track row.id) {
          <tr>
            @for (cell of row.cells; track cell.id) {
              @if (shouldSkipCell(cell.rowIndex, cell.colIndex)) {
                <!-- slot is part of a merged cell, origin td has the colspan/rowspan -->
              } @else {
                <td
                  [class]="'canvas-cell' + (cell.className ? ' ' + cell.className : '') + (isSelected(cell.rowIndex, cell.colIndex) ? ' canvas-cell-selected' : '')"
                  [attr.colspan]="getSpan(cell.rowIndex, cell.colIndex).colSpan > 1 ? getSpan(cell.rowIndex, cell.colIndex).colSpan : null"
                  [attr.rowspan]="getSpan(cell.rowIndex, cell.colIndex).rowSpan > 1 ? getSpan(cell.rowIndex, cell.colIndex).rowSpan : null"
                  (click)="onCellClick($event, cell.rowIndex, cell.colIndex, cell)"
                  (contextmenu)="onCellContextMenu($event, cell.rowIndex, cell.colIndex)"
                  (drop)="onDrop($event, cell)"
                  (dragover)="onDragOver($event)"
                  (dragleave)="onDragLeave($event)"
                >
                  @if (cell.widget) {
                    <app-widget-renderer
                      [widget]="cell.widget"
                      [cellId]="cell.id"
                      (removeWidget)="removeWidget(cell.id)"
                      (nestedTableChange)="updateNestedTable(cell.id, cell.widget.id, $event)"
                      (labelChange)="updateWidgetLabel(cell.id, cell.widget.id, $event)"
                      (optionsChange)="updateWidgetOptions(cell.id, cell.widget.id, $event)"
                      (optionSelect)="onRadioOptionSelect(cell.id, $event)"
                    />
                  } @else {
                    <div class="canvas-cell-placeholder">Drop component</div>
                  }
                </td>
              }
            }
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>
